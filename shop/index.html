<!doctype html>
<html lang="ja">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Shop - Dashboard</title>
    <link rel="stylesheet" href="../customer/style.css" />
    <style>
        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #f0f7ff;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #d0e3ff;
            cursor: pointer;
            /* ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ */
            transition: transform 0.2s;
        }

        .stat-card:active {
            transform: scale(0.95);
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007aff;
            display: block;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
        }

        /* è©³ç´°è¡¨ç¤ºã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .quick-view {
            margin-top: 10px;
            padding: 10px;
            background: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
            display: none;
            /* æœ€åˆã¯éš ã—ã¦ãŠã */
        }

        .quick-item {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            padding: 4px 0;
            border-bottom: 1px solid #f9f9f9;
        }
    </style>
</head>

<body>
    <h1>åº—èˆ—ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
    <p class="muted">ä¸­é‡ãƒ¬ãƒ³ã‚¬å‚ å•†åº—è¡—ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </p>

    <div class="stat-grid">
        <div class="stat-card" id="couponCard">
            <span id="couponCount" class="stat-value">0</span>
            <span class="stat-label">å…¬é–‹ä¸­ã®ã‚¯ãƒ¼ãƒãƒ³ â–¾</span>
            <div id="couponQuickView" class="quick-view text-left">
            </div>
        </div>

        <div class="stat-card">
            <span id="logCount" class="stat-value">0</span>
            <span class="stat-label">è“„ç©ã•ã‚ŒãŸè¡Œå‹•ãƒ­ã‚°</span>
        </div>
    </div>

    <div class="card row">
        <h2>ã‚¯ã‚¤ãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
        <div class="toolbar" style="flex-direction: column; align-items: stretch; gap: 10px;">
            <a class="btn primary" href="create_coupon.html" style="text-align: center;">ï¼‹ æ–°ã—ã„ã‚¯ãƒ¼ãƒãƒ³ã‚’ç™ºè¡Œã™ã‚‹</a>
            <a class="btn secondary" href="analysis.html" style="text-align: center;">ğŸ“Š AIåˆ†æãƒ»åˆ©ç”¨çŠ¶æ³ã‚’ç¢ºèª</a>
        </div>
    </div>

    <div class="card row" style="margin-top:20px;">
        <h3>æœ€è¿‘ã®ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³</h3>
        <ul id="systemStatus" class="muted" style="font-size:13px; padding-left:20px;">
            <li>ã‚·ã‚¹ãƒ†ãƒ ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ã€‚</li>
        </ul>
    </div>

    <div class="toolbar" style="margin-top:20px;">
        <a href="../index.html" class="btn">ã‚µãƒ¼ãƒ“ã‚¹TOPã¸æˆ»ã‚‹</a>
    </div>

    <script>
        const KEY_SHARED_POOL = "hk_shared_coupon_pool_v1";
        const KEY_USERDATA = "hk_userdata_v1";

        function updateDashboard() {
            // 1. å…¬é–‹ä¸­ã‚¯ãƒ¼ãƒãƒ³ã®è©³ç´°ã¨æ•°
            const pool = JSON.parse(localStorage.getItem(KEY_SHARED_POOL)) || [];
            document.querySelector("#couponCount").textContent = pool.length;

            const quickView = document.querySelector("#couponQuickView");
            if (pool.length > 0) {
                quickView.innerHTML = pool.map(c => `
                    <div class="quick-item">
                        <span>${c.title}</span>
                        <strong style="color:${c.remainingStock <= 5 ? '#ff3b30' : '#007aff'}">${c.remainingStock}æš</strong>
                    </div>
                `).join("");
            } else {
                quickView.innerHTML = "<p class='muted'>ãªã—</p>";
            }

            // 2. è“„ç©ã•ã‚ŒãŸãƒ­ã‚°ã®ç·æ•°
            const allUserData = JSON.parse(localStorage.getItem(KEY_USERDATA)) || {};
            let totalLogs = 0;
            Object.values(allUserData).forEach(user => {
                if (user.logs) totalLogs += user.logs.length;
            });
            document.querySelector("#logCount").textContent = totalLogs;

            const statusList = document.querySelector("#systemStatus");
            if (totalLogs > 0) {
                statusList.innerHTML = `<li>ç¾åœ¨ã€${totalLogs}ä»¶ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡Œå‹•ã‚’å­¦ç¿’ç”¨ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦è“„ç©æ¸ˆã¿ã§ã™ã€‚</li>`;
            }
        }

        // ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°ã‚’è¡¨ç¤º/éè¡¨ç¤ºã«ã™ã‚‹
        document.querySelector("#couponCard").addEventListener("click", () => {
            const view = document.querySelector("#couponQuickView");
            const isVisible = view.style.display === "block";
            view.style.display = isVisible ? "none" : "block";
        });

        updateDashboard();
        setInterval(updateDashboard, 5000);
    </script>
</body>

</html>