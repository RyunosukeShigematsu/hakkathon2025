<!doctype html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shop - åˆ†æ</title>

  <link rel="stylesheet" href="../customer/style.css" />

  <style>
    .analysis-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 18px;
      gap: 12px;
    }

    .shop-id {
      font-size: 13px;
      color: #666;
      margin-top: 6px;
    }

    .muted {
      color: #666;
      font-size: 13px;
    }

    /* ---- list ---- */
    .target-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #f0f0f0;
      font-size: 13px;
      gap: 10px;
      cursor: pointer;
      user-select: none;
    }

    .target-item:active {
      transform: scale(0.995);
      opacity: 0.9;
    }

    .target-left {
      text-align: left;
      flex: 1;
      min-width: 0;
    }

    .target-title {
      font-weight: 700;
      font-size: 14px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .target-sub {
      margin-top: 3px;
      font-size: 12px;
      color: #777;
    }

    /* ---- modal ---- */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.35);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 9999;
    }

    .modal {
      width: min(520px, 100%);
      background: #fff;
      border-radius: 16px;
      border: 1px solid #eee;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.18);
    }

    .modal-head {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 10px;
    }

    .modal-title {
      font-size: 16px;
      font-weight: 800;
      margin: 0;
      line-height: 1.3;
    }

    .modal-sub {
      margin-top: 4px;
      font-size: 12px;
      color: #777;
    }

    .icon-btn {
      border: 1px solid #eee;
      background: #fff;
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
    }

    .icon-btn:active {
      transform: scale(0.98);
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }

    .kpi {
      background: #f7f7f7;
      border: 1px solid #eee;
      border-radius: 12px;
      padding: 12px;
    }

    .kpi .label {
      font-size: 12px;
      color: #666;
    }

    .kpi .value {
      font-size: 22px;
      font-weight: 800;
      margin-top: 4px;
    }

    .bar-wrap {
      background: #eee;
      border-radius: 999px;
      height: 10px;
      overflow: hidden;
      margin-top: 10px;
    }

    .bar {
      height: 100%;
      width: 0%;
      background: #007aff;
      transition: width .5s ease;
    }

    .modal-foot {
      display: flex;
      gap: 10px;
      margin-top: 14px;
    }

    .modal-foot .btn {
      width: 100%;
      text-align: center;
    }

    /* ---- tag chips ---- */
    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .chip {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #eee;
      background: #fff;
      color: #333;
    }

    .chip .c {
      color: #666;
      margin-left: 6px;
    }
  </style>
</head>

<body>

  <div class="top-bar">
    <div>
      <h1 style="margin:0;">åˆ©ç”¨çŠ¶æ³ã®åˆ†æ</h1>
      <div id="shopDisplay" class="shop-id"></div>
    </div>
    <a href="home.html" class="btn secondary">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a>
  </div>

  <p class="muted">
    ã“ã®åº—èˆ—ã®ã‚¯ãƒ¼ãƒãƒ³å€™è£œï¼ˆå•†å“ã‚«ãƒ†ã‚´ãƒªï¼‰ã‚’ä¸€è¦§è¡¨ç¤ºã—ã¾ã™ã€‚
    å„é …ç›®ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€è¡¨ç¤ºå›æ•°ãƒ»é¸æŠå›æ•°ãƒ»é¸æŠç‡ã¨ã€é¸æŠã—ãŸäººã®ç‰¹å¾´ã‚’ç¢ºèªã§ãã¾ã™ã€‚
  </p>

  <div class="analysis-grid">
    <div class="card">
      <h3>ğŸ—‚ ã‚¯ãƒ¼ãƒãƒ³å€™è£œï¼ˆå•†å“ã‚«ãƒ†ã‚´ãƒªï¼‰ä¸€è¦§</h3>
      <div id="targetsList"></div>
    </div>
  </div>

  <!-- modal -->
  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modal-head">
        <div style="min-width:0;">
          <p id="modalTitle" class="modal-title"></p>
          <div id="modalSub" class="modal-sub"></div>
        </div>
        <button id="modalCloseBtn" class="icon-btn">é–‰ã˜ã‚‹</button>
      </div>

      <div class="kpi-grid">
        <div class="kpi">
          <div class="label">è¡¨ç¤ºå›æ•°</div>
          <div id="kpiImpressions" class="value">-</div>
        </div>
        <div class="kpi">
          <div class="label">é¸æŠå›æ•°</div>
          <div id="kpiSelections" class="value">-</div>
        </div>
      </div>

      <div class="kpi" style="margin-top:10px;">
        <div class="label">é¸æŠç‡ï¼ˆCTRï¼‰</div>
        <div id="kpiCtr" class="value">-</div>
        <div class="bar-wrap"><div id="ctrBar" class="bar"></div></div>
      </div>

      <div class="kpi" style="margin-top:10px;">
        <div class="label">é¸æŠã—ãŸäººã®ç‰¹å¾´</div>
        <div id="attrGender" class="muted" style="margin-top:6px;"></div>
        <div id="attrAge" class="muted" style="margin-top:6px;"></div>
        <div id="attrTags" style="margin-top:10px;"></div>
      </div>
    </div>
  </div>

  <script>
    const KEY_SHOP_SESSION = "hk_shop_session_v1";

    // âœ… æ—¢ã«å‹•ã„ã¦ã„ã‚‹ï¼šã‚«ãƒ†ã‚´ãƒªä¸€è¦§
    const API_TARGETS =
      "https://shigematsu.nkmr.io/hakkathon2025/server/api/shop_targets_list.php";

    // âœ… ã“ã“ã‚’ã‚ãªãŸã®é›†è¨ˆAPIã«ã™ã‚‹ï¼ˆé‡è¦ï¼‰
    // ã‚ãªãŸãŒè²¼ã£ãŸPHPã‚’ã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«åã§é…ç½®ã—ã¦ã­ï¼š
    // /hakkathon2025/server/api/shop_get_analysis.php
    const API_TARGET_STATS =
      "https://shigematsu.nkmr.io/hakkathon2025/server/api/shop_get_analysis.php";

    function safeParse(raw, fallback) {
      try { return JSON.parse(raw); } catch (e) { return fallback; }
    }

    const session = safeParse(localStorage.getItem(KEY_SHOP_SESSION), null);
    if (!session || !session.shopId) location.href = "./index.html";

    const SHOP_ID = session.shopId;
    const SHOP_NAME = session.shopName || "";
    const GENRE = session.genre || "";

    const namePart = SHOP_NAME ? (" / " + SHOP_NAME) : "";
    const genrePart = GENRE ? ("ï¼ˆ" + GENRE + "ï¼‰") : "";

    document.getElementById("shopDisplay").textContent =
      "åº—èˆ—ID: " + SHOP_ID + namePart + genrePart;

    async function fetchTargets() {
      const res = await fetch(API_TARGETS, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ shop_id: SHOP_ID })
      });

      const text = await res.text();
      let json;
      try { json = JSON.parse(text); }
      catch (e) {
        console.log("targets raw response:", text);
        return { ok: false, items: [] };
      }

      if (!json.ok || !Array.isArray(json.items)) return { ok: false, items: [] };
      return { ok: true, items: json.items };
    }

    async function fetchTargetStats(targetId) {
      const res = await fetch(API_TARGET_STATS, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ shop_id: SHOP_ID, target_id: targetId })
      });

      const text = await res.text();
      let json;
      try { json = JSON.parse(text); }
      catch (e) {
        console.log("stats raw response:", text);
        throw new Error("é›†è¨ˆAPIã®è¿”ç­”ãŒJSONã§ã¯ã‚ã‚Šã¾ã›ã‚“");
      }

      if (!json.ok) {
        throw new Error(json.message || "é›†è¨ˆAPIã‚¨ãƒ©ãƒ¼");
      }
      return json;
    }

    // ===== modal =====
    const modalBackdrop = document.getElementById("modalBackdrop");
    const modalCloseBtn = document.getElementById("modalCloseBtn");

    function openModal(title, sub, impressions, selections, ctr) {
      document.getElementById("modalTitle").textContent = title;
      document.getElementById("modalSub").textContent = sub;

      document.getElementById("kpiImpressions").textContent = String(impressions);
      document.getElementById("kpiSelections").textContent = String(selections);

      const ctrNum = Number(ctr || 0);
      document.getElementById("kpiCtr").textContent = (ctrNum * 100).toFixed(1) + "%";

      const bar = document.getElementById("ctrBar");
      const pct = Math.max(0, Math.min(100, Math.round(ctrNum * 100)));
      bar.style.width = pct + "%";

      modalBackdrop.style.display = "flex";
    }

    function closeModal() {
      modalBackdrop.style.display = "none";
    }

    modalCloseBtn.addEventListener("click", closeModal);
    modalBackdrop.addEventListener("click", (e) => {
      if (e.target === modalBackdrop) closeModal();
    });

    function renderAttr(stats) {
      const g = stats.genderCounts || {};
      const a = stats.ageBuckets || {};
      const tags = stats.topTags || [];
      const totalSel = Number(stats.selections || 0);

      if (totalSel === 0) {
        document.getElementById("attrGender").textContent = "æ€§åˆ¥: ãƒ‡ãƒ¼ã‚¿ãªã—";
        document.getElementById("attrAge").textContent = "å¹´é½¢: ãƒ‡ãƒ¼ã‚¿ãªã—";
        document.getElementById("attrTags").innerHTML = "<div class='muted'>å¥½ã¿ã‚¿ã‚°: ãƒ‡ãƒ¼ã‚¿ãªã—</div>";
        return;
      }

      const genderText =
        "æ€§åˆ¥: male " + (g.male || 0) +
        ", female " + (g.female || 0) +
        ", other " + (g.other || 0) +
        ", unknown " + (g.unknown || 0);

      const ageText =
        "å¹´é½¢: -19 " + (a["-19"] || 0) +
        ", 20s " + (a["20s"] || 0) +
        ", 30s " + (a["30s"] || 0) +
        ", 40s " + (a["40s"] || 0) +
        ", 50+ " + (a["50+"] || 0) +
        ", unknown " + (a.unknown || 0);

      document.getElementById("attrGender").textContent = genderText;
      document.getElementById("attrAge").textContent = ageText;

      if (!Array.isArray(tags) || tags.length === 0) {
        document.getElementById("attrTags").innerHTML = "<div class='muted'>å¥½ã¿ã‚¿ã‚°: ãƒ‡ãƒ¼ã‚¿ãªã—</div>";
        return;
      }

      document.getElementById("attrTags").innerHTML =
        "<div class='muted'>å¥½ã¿ã‚¿ã‚°ï¼ˆä¸Šä½ï¼‰</div>" +
        "<div class='chips'>" +
        tags.map(function (t) {
          return "<span class='chip'>" + t.tag + "<span class='c'>" + t.count + "</span></span>";
        }).join("") +
        "</div>";
    }

    function renderTargets(items) {
      const el = document.getElementById("targetsList");

      if (!items || items.length === 0) {
        el.innerHTML = "<p class='muted'>å€™è£œãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆcoupon_targetsãŒæœªç™»éŒ² or shop_idãŒé•ã†å¯èƒ½æ€§ï¼‰</p>";
        return;
      }

      el.innerHTML = items.map(function (t) {
        return (
          "<div class='target-item' data-target-id='" + t.target_id + "' data-target-name='" + t.target_name + "'>" +
          "  <div class='target-left'>" +
          "    <div class='target-title'>" + t.target_name + "</div>" +
          "    <div class='target-sub'>" + t.target_id + "</div>" +
          "  </div>" +
          "</div>"
        );
      }).join("");

      Array.prototype.forEach.call(el.querySelectorAll(".target-item"), function (row) {
        row.addEventListener("click", async function () {
          const targetId = row.getAttribute("data-target-id") || "";
          const targetName = row.getAttribute("data-target-name") || "";

          // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
          openModal(targetName, targetId, "-", "-", 0);
          document.getElementById("attrGender").textContent = "èª­ã¿è¾¼ã¿ä¸­...";
          document.getElementById("attrAge").textContent = "";
          document.getElementById("attrTags").innerHTML = "";

          try {
            const stats = await fetchTargetStats(targetId);

            openModal(
              targetName,
              targetId,
              stats.impressions || 0,
              stats.selections || 0,
              stats.ctr || 0
            );

            renderAttr(stats);
          } catch (e) {
            document.getElementById("attrGender").textContent = "å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ";
            document.getElementById("attrAge").textContent = "";
            document.getElementById("attrTags").innerHTML =
              "<div class='muted'>" + String(e.message || e) + "</div>";
          }
        });
      });
    }

    async function init() {
      const r = await fetchTargets();
      renderTargets(r.ok ? r.items : []);
    }

    init();
  </script>

</body>

</html>