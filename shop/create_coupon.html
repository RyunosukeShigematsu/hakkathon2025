<!doctype html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shop - クーポン作成</title>
  <link rel="stylesheet" href="../customer/style.css" />
  <style>
    .age-range-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .age-range-group input {
      flex: 1;
    }

    .muted {
      color: #666;
      font-size: 13px;
    }
  </style>
</head>

<body>
  <h1>【店舗用】クーポン作成</h1>
  <p class="muted">自店舗のカテゴリを選択し、割引タイプとターゲットを設定します。</p>

  <div class="card row">
    <p class="muted" id="shopDisplay" style="margin-top:0;"></p>

    <!-- DBから取得して表示 -->
    <label>クーポン対象カテゴリ</label>
    <select id="targetId"></select>

    <label>割引タイプ</label>
    <select id="discountType">
      <option value="free">無料</option>
      <option value="percent">〇〇%引</option>
      <option value="amount">〇円引</option>
    </select>

    <label id="discountValueLabel">割引値</label>
    <input id="discountValue" type="number" placeholder="例: 20">

    <label>ターゲット性別</label>
    <select id="targetGender">
      <option value="all">全員</option>
      <option value="male">男性</option>
      <option value="female">女性</option>
    </select>

    <label>ターゲット年齢層（最小 〜 最大）</label>
    <div class="age-range-group">
      <input id="targetAgeMin" type="number" placeholder="最小 (0)">
      <span>〜</span>
      <input id="targetAgeMax" type="number" placeholder="最大 (99)">
    </div>

    <label>関連タグ（カンマ区切り）</label>
    <input id="tags" placeholder="例: 学生,ランチ,ドリンク">

    <label>発行枚数（在庫上限）</label>
    <input id="totalStock" type="number" placeholder="例: 50">

    <div class="toolbar">
      <button class="primary" id="publishBtn">公開</button>
    </div>
  </div>

  <div class="toolbar" style="margin-top:20px;">
    <a href="home.html" class="btn secondary">ホーム画面に戻る</a>
  </div>

  <script>
    const KEY_SHOP_SESSION = "hk_shop_session_v1";

    // DBからカテゴリを取るAPI（PHP）
    const API_TARGETS = "https://shigematsu.nkmr.io/hakkathon2025/server/api/shop_targets_list.php";

    // DBにクーポンを保存するAPI（PHP）
    const API_CREATE_COUPON = "https://shigematsu.nkmr.io/hakkathon2025/server/api/shop_coupon_create.php";

    function getSession() {
      try { return JSON.parse(localStorage.getItem(KEY_SHOP_SESSION) || "null"); }
      catch { return null; }
    }

    function syncDiscountUI() {
      const type = document.getElementById("discountType").value;
      const input = document.getElementById("discountValue");
      const label = document.getElementById("discountValueLabel");

      if (type === "free") {
        label.textContent = "割引値（不要）";
        input.value = 0;
        input.disabled = true;
      } else if (type === "percent") {
        label.textContent = "割引率（%）";
        input.disabled = false;
        input.placeholder = "例: 20";
      } else {
        label.textContent = "割引額（円）";
        input.disabled = false;
        input.placeholder = "例: 200";
      }
    }

    async function loadTargets() {
      const session = getSession();
      if (!session?.shopId) {
        alert("ログイン情報がありません。ログイン画面へ戻ります。");
        location.href = "index.html";
        return;
      }

      document.getElementById("shopDisplay").textContent =
        `店舗ID: ${session.shopId} / ${session.shopName}`;

      const sel = document.getElementById("targetId");
      sel.innerHTML = "";

      const res = await fetch(API_TARGETS, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ shop_id: session.shopId })
      });

      const text = await res.text();
      let json;
      try { json = JSON.parse(text); }
      catch {
        console.log("raw response:", text);
        alert("サーバ応答が不正です（Network→Response確認）");
        return;
      }

      if (!json.ok) {
        console.log(json);
        alert("カテゴリ取得に失敗しました");
        return;
      }

      const items = (json.items || []).filter(x => x.is_active === 1);
      if (items.length === 0) {
        sel.innerHTML = `<option value="">カテゴリなし</option>`;
        return;
      }

      for (const t of items) {
        const opt = document.createElement("option");
        opt.value = t.target_id;
        opt.textContent = t.target_name;
        sel.appendChild(opt);
      }

      sel.selectedIndex = 0;
    }

    document.getElementById("discountType").addEventListener("change", syncDiscountUI);

    // 公開ボタン：DBへ保存
    document.getElementById("publishBtn").addEventListener("click", async () => {
      const session = getSession();
      if (!session?.shopId) {
        alert("ログイン情報がありません");
        location.href = "index.html";
        return;
      }

      const targetId = document.getElementById("targetId").value;
      const discountType = document.getElementById("discountType").value;
      const discountValue = Number(document.getElementById("discountValue").value);
      const gender = document.getElementById("targetGender").value;
      const ageMin = Number(document.getElementById("targetAgeMin").value || 0);
      const ageMax = Number(document.getElementById("targetAgeMax").value || 99);
      const tags = document.getElementById("tags").value.split(",").map(s => s.trim()).filter(Boolean);
      const totalStock = Number(document.getElementById("totalStock").value);

      if (!targetId || !totalStock) {
        alert("カテゴリと発行枚数は必須です");
        return;
      }
      if (discountType === "percent" && (discountValue <= 0 || discountValue > 100)) {
        alert("割引率は 1〜100 で入力してください");
        return;
      }
      if (discountType === "amount" && discountValue <= 0) {
        alert("割引額は 1円以上で入力してください");
        return;
      }

      try {
        const res = await fetch(API_CREATE_COUPON, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            shop_id: session.shopId,
            target_id: targetId,
            discount_type: discountType,
            discount_value: discountType === "free" ? 0 : discountValue,
            target_gender: gender,
            target_age_min: ageMin,
            target_age_max: ageMax,
            tags: tags,
            total_stock: totalStock
          })
        });

        const text = await res.text();
        let json;
        try { json = JSON.parse(text); }
        catch {
          console.log("raw response:", text);
          alert("サーバ応答が不正です（Network→Response確認）");
          return;
        }

        if (!json.ok) {
          console.log(json);
          alert(json.message || "保存に失敗しました");
          return;
        }

        location.href = "home.html";

        // 入力リセット
        document.getElementById("discountType").value = "free";
        syncDiscountUI();
        document.getElementById("targetGender").value = "all";
        document.getElementById("targetAgeMin").value = "";
        document.getElementById("targetAgeMax").value = "";
        document.getElementById("tags").value = "";
        document.getElementById("totalStock").value = "";

      } catch (e) {
        console.error(e);
        alert("通信エラー（API URL / サーバ / CORS を確認）");
      }
    });

    // init
    syncDiscountUI();
    loadTargets();
  </script>
</body>

</html>