<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Home</title>
  <link rel="stylesheet" href="../style.css" />
</head>

<body>
  <h1>ホーム</h1>
  <p id="who" class="muted"></p>

  <div class="card">
    <div class="toolbar">
      <a class="btn primary" href="receipt.html">レシート登録</a>
    </div>

    <hr />

    <h2 style="margin:0 0 10px;">所持クーポン</h2>
    <div id="owned"></div>
  </div>

  <div class="toolbar" style="margin-top:12px;">
    <button class="secondary" id="logoutBtn">ログアウト</button>
  </div>

  <!-- ===== オーバーレイ ===== -->
  <div id="overlay"
       style="position:fixed; inset:0; background:rgba(0,0,0,.5);
              display:none; align-items:center; justify-content:center;
              padding:16px; z-index:9999;">
    <div style="background:white; border-radius:16px;
                width:min(420px, 100%); padding:16px;">

      <div id="ovTitle" style="font-weight:800; font-size:16px;"></div>
      <div id="ovDesc" class="muted" style="margin-top:6px;"></div>

      <!-- 確認 -->
      <div id="ovStageConfirm" style="margin-top:14px;">
        <p class="muted">このクーポンを使用しますか？</p>
        <div class="toolbar" style="margin-top:12px;">
          <button class="primary" id="ovUseBtn">使用する</button>
          <button class="secondary" id="ovCancelBtn">キャンセル</button>
        </div>
      </div>

      <!-- コード表示 -->
      <div id="ovStageCode" style="display:none; margin-top:14px;">
        <div class="muted">店員さんにこのコードを見せてください</div>
        <div id="ovCode"
             style="font-size:34px; font-weight:900;
                    letter-spacing:2px; margin-top:8px;"></div>
        <div class="muted" style="margin-top:6px;">
          残り <span id="ovSec">3:00</span>
        </div>
        <div class="toolbar" style="margin-top:12px;">
          <button class="secondary" id="ovCloseBtn">閉じる</button>
        </div>
      </div>

    </div>
  </div>

  <script src="../app.js"></script>

  <script>
  window.addEventListener("DOMContentLoaded", () => {

    requireLoginFromPages();

    const API_USER_COUPONS =
      "https://shigematsu.nkmr.io/hakkathon2025/server/api/user_coupons_by_ids.php";

    const me = getUserId();
    if (me) document.getElementById("who").textContent = `ログイン中: ${me}`;

    let currentCoupon = null;
    let timerId = null;

    /* =============================
       クーポン削除（ID方式）
    ============================= */
    function removeCouponById(couponId) {
      saveMyData(d => {
        const ids = d.selectedCouponIds ?? [];
        d.selectedCouponIds = ids.filter(id => String(id) !== String(couponId));
        return d;
      });
      renderOwned();
    }

    /* =============================
       オーバーレイ制御
    ============================= */
    function openOverlay(coupon) {
      currentCoupon = coupon;

      document.getElementById("ovTitle").textContent = coupon.shopName;
      document.getElementById("ovDesc").textContent =
        `対象メニュー: ${coupon.menuName} / ${coupon.discountLabel}`;

      document.getElementById("ovStageConfirm").style.display = "block";
      document.getElementById("ovStageCode").style.display = "none";
      document.getElementById("overlay").style.display = "flex";
    }

    function closeOverlay() {
      if (timerId) clearInterval(timerId);
      timerId = null;
      document.getElementById("overlay").style.display = "none";
      currentCoupon = null;
    }

    function generateCode() {
      const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
      return letters[Math.floor(Math.random()*26)] +
             letters[Math.floor(Math.random()*26)] +
             String(Math.floor(Math.random()*100)).padStart(2,"0");
    }

    function startCountdown(code) {
      document.getElementById("ovStageConfirm").style.display = "none";
      document.getElementById("ovStageCode").style.display = "block";
      document.getElementById("ovCode").textContent = code;

      let sec = 180; // 3:00
      document.getElementById("ovSec").textContent = "3:00";

      timerId = setInterval(() => {
        sec--;

        const m = Math.floor(sec / 60);
        const s = String(sec % 60).padStart(2, "0");
        document.getElementById("ovSec").textContent = `${m}:${s}`;

        if (sec <= 0) {
          clearInterval(timerId);
          timerId = null;

          if (currentCoupon) {
            removeCouponById(currentCoupon.id);
          }

          closeOverlay();
        }
      }, 1000);
    }

    /* =============================
       ボタンイベント
    ============================= */
    document.getElementById("ovCancelBtn")
      .addEventListener("click", closeOverlay);

    document.getElementById("ovCloseBtn")
      .addEventListener("click", () => {
        if (currentCoupon) {
          removeCouponById(currentCoupon.id);
        }
        closeOverlay();
      });

    document.getElementById("ovUseBtn")
      .addEventListener("click", () => {
        if (!currentCoupon) return;
        const code = generateCode();
        startCountdown(code);
      });

    document.getElementById("logoutBtn")
      .addEventListener("click", () => {
        logoutDemo();
        location.href = "../index.html";
      });

    /* =============================
       所持クーポン描画（DB参照）
    ============================= */
    async function renderOwned() {
      const data = loadMyData();
      const ids = data?.selectedCouponIds ?? [];

      if (ids.length === 0) {
        document.getElementById("owned").innerHTML =
          `<p class="muted">まだクーポンがありません。</p>`;
        return;
      }

      try {
        const res = await fetch(API_USER_COUPONS, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ids })
        });

        const json = await res.json();
        if (!json.ok) {
          document.getElementById("owned").innerHTML =
            `<p class="muted">取得失敗</p>`;
          return;
        }

        const items = json.items ?? [];

        document.getElementById("owned").innerHTML = `
          <div class="row">
            ${items.map(c => `
              <div class="coupon">
                <strong>${c.shopName}</strong>

                <div style="margin:12px 0; border:1px solid #eee;
                            border-radius:12px; height:120px;
                            display:flex; align-items:center;
                            justify-content:center;
                            background:#fafafa; color:#999;">
                  ${c.imageUrl
                    ? `<img src="${c.imageUrl}"
                           style="max-width:100%; max-height:100%;
                                  border-radius:12px;">`
                    : `No Image`}
                </div>

                <div class="muted">
                  対象メニュー: <strong>${c.menuName}</strong>
                </div>

                <div style="font-weight:bold; margin-top:6px;">
                  ${c.discountLabel}
                </div>

                <div class="toolbar" style="margin-top:10px;">
                  <button class="primary useBtn"
                          data-id="${c.id}">
                    このクーポンを使う
                  </button>
                </div>
              </div>
            `).join("")}
          </div>
        `;

        document.querySelectorAll(".useBtn").forEach(btn => {
          btn.addEventListener("click", () => {
            const id = btn.dataset.id;
            const coupon = items.find(x => String(x.id) === String(id));
            if (!coupon) return;
            openOverlay(coupon);
          });
        });

      } catch (e) {
        document.getElementById("owned").innerHTML =
          `<p class="muted">通信エラー</p>`;
      }
    }

    renderOwned();

  });
  </script>
</body>
</html>