<!doctype html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Receipt</title>
  <link rel="stylesheet" href="../style.css" />
</head>

<body>
  <h1>レシート読み込み</h1>

  <div class="card row">
    <p class="muted">
      ※今回はレシートが用意できないため手入力で登録を行なってください．
    </p>

    <label>入店したお店</label>
    <select id="storeSelect">
      <option value="">選択してください</option>
    </select>

    <label>食べたメニュー（複数選択可）</label>
    <div id="menuChecklist" class="card" style="padding:12px; border-radius:12px;">
      <p class="muted" style="margin:0;">先にお店を選択してください</p>
    </div>

    <label>支払額</label>
    <input id="totalAmount" type="number" readonly placeholder="メニューを選ぶと合計が入ります" />

    <label>食べた時間</label>
    <select id="timeSelect">
      <option value="">選択してください</option>
    </select>

    <div class="toolbar">
      <button class="primary" id="saveBtn">登録</button>
      <a class="btn secondary" href="home.html">ホームへ戻る</a>
    </div>
  </div>

  <script src="../app.js"></script>
  <script>
    requireLoginFromPages();

    // ★ ページ読み込み時にレシートをリセット（リロードで消える）
    saveMyData(d => {
      delete d.receipt;
      d.candidates = [];
      d.retries = 0;
      d.isRetryActive = false;
      return d;
    });

    // ===== マスタ（デモ用）=====
    // 店舗は固定5つ。各店舗にメニュー5つ（価格つき）。
    const STORE_MENU_MASTER = {
      "ren-ga-meat": {
        storeName: "手しおご飯 玄", // 画像のタイトル「お肉の定食」より
        menus: [
          // 鶏肉料理
          { id: "chicken_katsu", name: "やわらかチキンカツ定食", price: 1200 },
          { id: "chicken_ankake", name: "揚げ鶏のあんかけ定食", price: 1230 },
          { id: "chicken_mizore", name: "チキンのみぞれ煮定食", price: 1220 },
          { id: "chicken_nanban", name: "手作りタルタルのやわらかチキン南蛮定食", price: 1250 },
          { id: "chicken_kurozu", name: "鶏肉と野菜の黒酢あん定食", price: 1280 },
          { id: "chicken_tomato", name: "五種の野菜とチキンのトマト煮定食", price: 1320 },
          { id: "chicken_saute", name: "青唐辛子味噌のチキンソテー定食", price: 1280 },

          // 豚肉料理
          { id: "pork_shogayaki", name: "玉ねぎたっぷり豚生姜焼き定食", price: 1380 },
          { id: "pork_chops", name: "ごはんがすすむポークチャップ定食", price: 1480 },
          { id: "pork_tonkatsu", name: "厚切り三元豚のロースとんかつ定食", price: 1420 },
          { id: "pork_oroshi_tonkatsu", name: "厚切り三元豚のロースおろしとんかつ定食", price: 1520 },
          { id: "pork_kakuni", name: "とろ〜り豚の角煮定食", price: 1500 },

          // ハンバーグ
          { id: "hamburg_oroshi", name: "和風おろしハンバーグ定食", price: 1520 },
          { id: "hamburg_egg", name: "目玉焼のせおふくろさんのハンバーグ定食", price: 1520 },
          { id: "hamburg_tomato", name: "特製トマト煮込みハンバーグ定食", price: 1520 },

          // 煮魚・炭火焼
          { id: "fish_nitsuke", name: "スケソウダラの煮つけ(醤油味)定食", price: 1280 }, //
          { id: "fish_hokke", name: "しまほっけの炭火焼定食(カボチャ煮付)", price: 1550 }, //
          { id: "fish_kamasu", name: "山陰沖産カマスの開き炭火焼定食(カボチャ煮付)", price: 1450 }, //
          { id: "fish_katsu", name: "バチまぐろのカツ定食", price: 1650 }, //

          // 漬け・丼
          { id: "fish_zuke_teishoku", name: "漬まぐろ定食", price: 1600 }, //
          { id: "fish_zuke_don", name: "漬まぐろのばくだん丼", price: 1350 }
        ]
      },
      "ren-ga-spanish": {
        storeName: "スペインバル siono",
        menus: [
          // 冷菜・タパス
          { id: "spanish_uni_pudding", name: "殻付き濃厚ウニプリン（2個）", price: 980 },
          { id: "spanish_potato_salad", name: "ボケリア特製ポテトサラダ", price: 680 },
          { id: "spanish_pan_con_tomate", name: "パンコントマテ", price: 550 },
          { id: "spanish_olives", name: "オリーブのマリネ", price: 480 },
          { id: "spanish_pickles", name: "季節野菜のピクルス", price: 500 },

          // 温菜・アヒージョ
          { id: "spanish_tortilla", name: "トルティージャ（スペイン風オムレツ）", price: 750 },
          { id: "spanish_shrimp_ajillo", name: "海老とマッシュルームのアヒージョ", price: 950 },
          { id: "spanish_french_fries", name: "ボケリア特製ポテトフライ", price: 650 },

          // メイン・パエリア
          { id: "spanish_paella_seafood", name: "魚介たっぷりのシーフードパエリア", price: 2400 },
          { id: "spanish_paella_squid_ink", name: "漆黒のイカ墨パエリア", price: 2200 },
          { id: "spanish_iberico_steak", name: "イベリコ豚の肩ロースステーキ", price: 1850 },

          // 生ハム・チーズ
          { id: "spanish_jamon_serrano", name: "ハモンセラーノ（スペイン産生ハム）", price: 1200 },
          { id: "spanish_cheese_platter", name: "スペイン産チーズの盛り合わせ", price: 1350 }
        ]
      },
      "ren-ga-izakaya": {
        storeName: "レンガ坂居酒屋",
        menus: [
          { id: "beer", name: "生ビール", price: 580 },
          { id: "karaage", name: "唐揚げ", price: 650 },
          { id: "sashimi", name: "刺身盛り合わせ", price: 1680 },
          { id: "yakitori", name: "焼き鳥盛り", price: 980 },
          { id: "nomihodai", name: "飲み放題コース", price: 2200 }
        ]
      },
      "ren-ga-sushi": {
        storeName: "レンガ坂すし",
        menus: [
          { id: "nigiri10", name: "握り10貫", price: 2200 },
          { id: "kaisendon", name: "海鮮丼", price: 1580 },
          { id: "makimono", name: "巻物セット", price: 980 },
          { id: "chawanmushi", name: "茶碗蒸し", price: 480 },
          { id: "jyou_nigiri", name: "特上握り", price: 3200 }
        ]
      },
      "ren-ga-bakery": {
        storeName: "レンガ坂ベーカリー",
        menus: [
          { id: "croissant", name: "クロワッサン", price: 260 },
          { id: "anpan", name: "あんぱん", price: 220 },
          { id: "sandwich", name: "サンドイッチ", price: 520 },
          { id: "set", name: "パン＋ドリンクセット", price: 680 },
          { id: "shokupan", name: "食パン（1斤）", price: 420 }
        ]
      }
    };

    // 時間（9:00〜23:00を1時間刻み）
    function buildTimeOptions() {
      const list = [];
      for (let h = 9; h <= 23; h++) {
        const hh = String(h).padStart(2, "0");
        list.push(`${hh}:00`);
      }
      return list;
    }

    function fillSelectOptions(selectEl, options, placeholder = "選択してください") {
      selectEl.innerHTML = "";
      const ph = document.createElement("option");
      ph.value = "";
      ph.textContent = placeholder;
      selectEl.appendChild(ph);

      options.forEach(opt => {
        const o = document.createElement("option");
        o.value = opt.value;
        o.textContent = opt.label;
        selectEl.appendChild(o);
      });
    }

    function yen(n) {
      try { return new Intl.NumberFormat("ja-JP").format(n); } catch { return String(n); }
    }

    function getSelectedMenuIds() {
      return Array.from(document.querySelectorAll('input[name="menuItem"]:checked')).map(el => el.value);
    }

    function computeTotal(storeId, selectedIds) {
      if (!storeId) return 0;
      const menus = STORE_MENU_MASTER[storeId]?.menus ?? [];
      const priceMap = new Map(menus.map(m => [m.id, m.price]));
      return selectedIds.reduce((sum, id) => sum + (priceMap.get(id) ?? 0), 0);
    }

    function computeRetries(total) {
      // とりあえず現行互換：500円ごとに1回
      return Math.floor(total / 500);
    }

    // ===== 初期描画 =====
    const storeOptions = Object.entries(STORE_MENU_MASTER).map(([storeId, v]) => ({
      value: storeId,
      label: v.storeName
    }));
    fillSelectOptions(qs("#storeSelect"), storeOptions);

    fillSelectOptions(
      qs("#timeSelect"),
      buildTimeOptions().map(t => ({ value: t, label: t }))
    );

    // 店舗選択→チェックリスト生成
    function renderMenuChecklist(storeId, selectedIds = []) {
      const box = qs("#menuChecklist");
      box.innerHTML = "";

      if (!storeId) {
        const p = document.createElement("p");
        p.className = "muted";
        p.style.margin = "0";
        p.textContent = "先にお店を選択してください";
        box.appendChild(p);
        qs("#totalAmount").value = "";
        return;
      }

      const menus = STORE_MENU_MASTER[storeId].menus;

      menus.forEach(m => {
        const row = document.createElement("label");
        row.style.display = "flex";
        row.style.alignItems = "center";
        row.style.justifyContent = "space-between";
        row.style.gap = "12px";
        row.style.padding = "10px 8px";
        row.style.borderBottom = "1px solid #eee";

        const left = document.createElement("div");
        left.style.display = "flex";
        left.style.alignItems = "center";
        left.style.gap = "10px";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.name = "menuItem";
        cb.value = m.id;
        cb.checked = selectedIds.includes(m.id);

        const name = document.createElement("span");
        name.textContent = m.name;

        left.appendChild(cb);
        left.appendChild(name);

        const price = document.createElement("span");
        price.className = "muted";
        price.textContent = `¥${yen(m.price)}`;

        row.appendChild(left);
        row.appendChild(price);

        box.appendChild(row);
      });

      // 変更時に合計更新（毎回反映）
      box.onchange = () => {
        const ids = getSelectedMenuIds();
        const total = computeTotal(storeId, ids);
        qs("#totalAmount").value = total;
      };

      // 初期合計
      const total = computeTotal(storeId, selectedIds);
      qs("#totalAmount").value = total;
    }

    on("#storeSelect", "change", (e) => {
      const storeId = e.target.value;
      renderMenuChecklist(storeId, []);
    });

    // 既存データを反映
    const data = loadMyData();
    if (data.receipt) {
      const r = data.receipt;

      qs("#storeSelect").value = r.storeId ?? "";
      if (r.storeId) {
        renderMenuChecklist(r.storeId, r.menuIds ?? []);
      }

      qs("#timeSelect").value = r.time ?? "";

      // 念のため合計反映
      const total = computeTotal(r.storeId, r.menuIds ?? []);
      qs("#totalAmount").value = total;
    } else {
      // 初期は未選択状態を描画
      renderMenuChecklist("", []);
    }

    // 登録
    on("#saveBtn", "click", () => {
      const storeId = qs("#storeSelect").value;
      const time = qs("#timeSelect").value;
      const menuIds = getSelectedMenuIds();

      if (!storeId || !time) {
        alert("お店と時間を選択してください");
        return;
      }
      if (menuIds.length === 0) {
        alert("メニューを1つ以上選択してください");
        return;
      }

      const storeName = STORE_MENU_MASTER[storeId].storeName;
      const menus = STORE_MENU_MASTER[storeId].menus;
      const menuMap = new Map(menus.map(m => [m.id, m]));

      const selectedMenus = menuIds
        .map(id => menuMap.get(id))
        .filter(Boolean)
        .map(m => ({ id: m.id, name: m.name, price: m.price }));

      const total = computeTotal(storeId, menuIds);
      const retries = computeRetries(total);

      saveMyData(d => {
        d.receipt = {
          storeId,
          store: storeName,
          time,
          menuIds,
          menus: selectedMenus,  // [{id,name,price}, ...]
          total,                 // 合計金額＝支払額
          savedAt: Date.now()
        };

        // 金額に応じたやり直し回数
        d.retries = retries;

        // クーポン画面で新規生成させる
        d.candidates = [];

        // やり直しを有効化
        d.isRetryActive = true;

        return d;
      });

      location.href = "coupons.html";
    });
  </script>
</body>

</html>