<!doctype html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Coupons</title>
  <link rel="stylesheet" href="../style.css" />
</head>

<body>
  <h1>クーポン候補</h1>
  <p class="muted">3つの中から1つ選んでください。やり直しもできます。</p>

  <div class="toolbar">
    <button class="primary" id="regenBtn">候補をやり直す</button>
    <span id="retryCount" style="margin-left:10px; font-weight:bold; font-size:14px;"></span>
  </div>

  <div style="height:12px;"></div>
  <div id="grid" class="grid"></div>

  <script src="../app.js"></script>
  <script>
    requireLoginFromPages();

    // =========================================
    // 将来：ここを「shop側で作ったクーポン一覧（DB/API）」に差し替えるだけ
    // 1クーポン = 1つの塊（店・商品・割引・画像…）
    // =========================================
    const COUPON_CATALOG = [
      {
        id: "coupon_001",
        shopId: "shop_01",
        shopName: "仮店舗A",
        productId: "p_01",
        menuName: "割引対象メニューA",
        discountPercent: 10,
        imageUrl: null, // 例: "../images/coupon_a.png"
      },
      {
        id: "coupon_002",
        shopId: "shop_02",
        shopName: "仮店舗B",
        productId: "p_02",
        menuName: "割引対象メニューB",
        discountPercent: 20,
        imageUrl: null,
      },
      {
        id: "coupon_003",
        shopId: "shop_03",
        shopName: "仮店舗C",
        productId: "p_03",
        menuName: "割引対象メニューC",
        discountPercent: 30,
        imageUrl: null,
      }
    ];

    // 配置をランダムにするだけ（クーポンの中身は塊のまま）
    function shuffle(arr) {
      const a = [...arr];
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function consumeOneRetryOrThrow() {
      const d = loadMyData();

      if (!d?.isRetryActive) {
        throw new Error("やり直しは利用できません");
      }
      if ((d.retries ?? 0) <= 0) {
        throw new Error("やり直し回数が残っていません");
      }

      // 1回消費
      saveMyData(x => {
        x.retries = (x.retries ?? 0) - 1;
        // 0になったら終了扱いにしてボタンを無効化
        if (x.retries <= 0) {
          x.retries = 0;
          x.isRetryActive = false;
        }
        return x;
      });
    }

    // 常に3枚欲しいので、足りなければダミーを追加（将来はcatalogが十分ある前提でもOK）
    function ensureThree(list) {
      const out = [...list];
      let n = 1;
      while (out.length < 3) {
        out.push({
          id: `dummy_${n++}`,
          shopId: null,
          shopName: `仮店舗${out.length + 1}`,
          productId: null,
          menuName: `割引対象メニュー${out.length + 1}`,
          discountPercent: 10 * (out.length + 1),
          imageUrl: null,
          isDummy: true
        });
      }
      return out.slice(0, 3);
    }

    // 候補生成（今は catalog からランダム配置するだけ）
    function buildCandidates() {
      const shuffled = shuffle(COUPON_CATALOG);
      return ensureThree(shuffled).slice(0, 3);
    }

    function updateRetryDisplay() {
      const d = loadMyData();
      const retryEl = qs("#retryCount");

      if (!d || !d.isRetryActive || (d.retries ?? 0) <= 0) {
        retryEl.textContent = "（やり直しは利用できません）";
        qs("#regenBtn").disabled = true;
        qs("#regenBtn").style.opacity = 0.5;
      } else {
        retryEl.textContent = `（残りやり直し回数: ${d.retries}回）`;
        qs("#regenBtn").disabled = false;
        qs("#regenBtn").style.opacity = 1;
      }
    }

    function render(candidates) {
      qs("#grid").innerHTML = candidates.map(c => `
        <div class="coupon">
          <strong>${c.shopName}</strong>

          <div style="margin:12px 0; border:1px solid #eee; border-radius:12px; height:120px; display:flex; align-items:center; justify-content:center; background:#fafafa; color:#999;">
            ${c.imageUrl ? `<img src="${c.imageUrl}" style="max-width:100%; max-height:100%; border-radius:12px;">` : `No Image`}
          </div>

          <div class="muted">対象メニュー: <strong>${c.menuName}</strong></div>
          <div style="font-size:18px; font-weight:bold; margin:8px 0;">
            ${c.discountPercent}% OFF
          </div>

          <div class="toolbar">
            <button data-id="${c.id}" class="primary selectBtn">
              これにする
            </button>
          </div>
        </div>
      `).join("");

      qsa(".selectBtn").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.dataset.id;
          const picked = candidates.find(c => c.id === id);
          if (!picked) return;

          // ★選択したクーポンを「塊のまま」保存
          saveMyData(d => {
            d.couponsOwned = d.couponsOwned ?? [];
            d.couponsOwned.unshift({
              id: picked.id,
              shopId: picked.shopId,
              shopName: picked.shopName,
              productId: picked.productId,
              menuName: picked.menuName,
              discountPercent: picked.discountPercent,
              imageUrl: picked.imageUrl,
              acquiredAt: Date.now()
            });

            d.candidates = [];
            d.isRetryActive = false;
            d.retries = 0;
            return d;
          });

          location.href = "home.html";
        });
      });
    }

    function init() {
      const candidates = buildCandidates();

      // 画面表示に使っている候補を保存（他ページとの整合）
      saveMyData(d => { d.candidates = candidates; return d; });

      render(candidates);
      updateRetryDisplay();
    }

    on("#regenBtn", "click", () => {
      try {
        consumeOneRetryOrThrow();      // ★ここで回数を減らす
        const candidates = buildCandidates();
        saveMyData(d => { d.candidates = candidates; return d; });
        render(candidates);
        updateRetryDisplay();          // ★減った回数を反映
      } catch (e) {
        alert(e?.message ?? "やり直しに失敗しました");
        updateRetryDisplay();
      }
    });

    init();
  </script>
</body>

</html>