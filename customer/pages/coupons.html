<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Coupons (3 candidates)</title>
  <link rel="stylesheet" href="../style.css" />
</head>
<body>
  <h1>クーポン候補（3つ）</h1>
  <p class="muted">3つの中から1つ選んでください。やり直しもできます。</p>

  <div class="toolbar">
    <button class="primary" id="regenBtn">候補をやり直す</button>
    <span id="retryCount" style="margin-left:10px; font-weight:bold; font-size:14px;"></span>
    <a class="btn secondary" href="home.html">ホームへ戻る</a>
  </div>

  <div style="height:12px;"></div>
  <div id="grid" class="grid"></div>

  <script src="../app.js"></script>
  <script>
    requireLoginFromPages();

    // coupons.html のスクリプト内

      // 1. 最新データの読み込み
      let data = loadMyData();

      // 2. もし候補が空、かつレシート保存直後（isRetryActiveがtrue）なら初回生成を行う
      if ((!data.candidates || data.candidates.length === 0) && data.isRetryActive) {
        try {
          // isRetry=false として初回生成（レシート情報が反映されたスコアリングが行われる）
          data.candidates = generateCandidates(false);
        } catch (e) {
          console.error("生成エラー:", e);
        }
      }

      // 3. 表示反映
      render(data.candidates);
      updateRetryDisplay();

    // 回数表示とボタンの状態を更新する関数
    function updateRetryDisplay() {
      const data = loadMyData();
      const retryEl = qs("#retryCount");
      
      // データがない場合や権利がない場合をガード
      if (!data || !data.isRetryActive || data.retries <= 0) {
        retryEl.textContent = "（やり直しは利用できません）";
        qs("#regenBtn").disabled = true;
        qs("#regenBtn").style.opacity = 0.5;
      } else {
        retryEl.textContent = `（残りやり直し回数: ${data.retries}回）`;
        qs("#regenBtn").disabled = false;
        qs("#regenBtn").style.opacity = 1;
      }
    }

    function render(candidates) {
        if (!candidates || candidates.length === 0) {
          qs("#grid").innerHTML = `<p class="muted">まだ候補がありません。「候補を生成」を押してください。</p>`;
          return;
        }

        // 最新の在庫状況を反映させるために共有プールを取得
        const sharedPool = JSON.parse(localStorage.getItem("hk_shared_coupon_pool_v1")) || [];

        qs("#grid").innerHTML = candidates.map(c => {
          // 共有プールから最新の在庫数を探す
          const liveData = sharedPool.find(p => p.title === c.title);
          const stock = liveData ? liveData.remainingStock : 0;
          const isLow = stock > 0 && stock <= 5; // 残り5枚以下なら警告

          return `
        <div class="coupon">
          <div style="display:flex; justify-content:space-between; align-items:flex-start;">
            <strong>${c.title}</strong>
            ${isLow ? '<span class="badge" style="background:#ff3b30; color:white;">残りわずか！</span>' : ''}
          </div>
          <div class="muted">割引: ${c.off} 円</div>
          
          <div style="font-size: 12px; margin: 8px 0; color: ${stock === 0 ? '#ff3b30' : '#666'};">
            現在の発行残数: <strong>${stock}</strong> 枚
          </div>

          <div class="badges">${(c.tags || []).map(t => `<span class="badge">${t}</span>`).join("")}</div>
          
          <div class="toolbar">
            <button data-id="${c.id}" class="primary selectBtn" ${stock <= 0 ? 'disabled' : ''}>
              ${stock <= 0 ? '予定枚数終了' : 'これにする'}
            </button>
          </div>
        </div>
      `}).join("");

        qsa(".selectBtn").forEach(btn => {
          btn.addEventListener("click", () => {
            const id = btn.dataset.id;
            try {
              selectCandidate(id);
              alert("選択しました！ホームで確認できます。");
              location.href = "home.html";
            } catch (e) {
              alert(e.message ?? "失敗しました");
            }
          });
        });
      }

    // --- 初期表示処理 ---
    const currentData = loadMyData();
    render(currentData.candidates);
    updateRetryDisplay(); // 画面を開いた瞬間に回数をチェック

    // --- イベントリスナー ---
    on("#regenBtn", "click", () => {
      try {
        // ★引数 true を渡して「やり直し」として実行
        const candidates = generateCandidates(true); 
        render(candidates);
        updateRetryDisplay(); // 実行後に回数を更新
      } catch (e) {
        alert(e.message ?? "やり直しに失敗しました");
      }
    });
  </script>
</body>
</html>